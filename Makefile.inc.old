
ifneq "$(findstring lib,$(shell ls ..))" ""
_LIBLOC=../lib
else
ifneq "$(findstring lib,$(shell ls ../..))" ""
_LIBLOC=../../lib
endif
endif

# Always include core
CFLAGS+=-I. -I$(_LIBLOC)
LIBS+=-ldl -L$(_LIBLOC) -lsolard -lpaho-mqtt3c -lpthread
ifneq ($(LIB),yes)
DEPS+=$(_LIBLOC)/libsolard.a
endif
LDFLAGS+=-rdynamic

SRCS+=$(shell IFS=","; for i in $(TRANSPORTS); do printf "../../transports/%s.c " $${i}; done)

# Debug
ifeq ($(DEBUG),yes)
CFLAGS+=-Wall -g -DDEBUG=1
else
CFLAGS+=-Wall -O2 -pipe
endif

ifneq "$(findstring bluetooth,$(TRANSPORTS))" ""
BLUETOOTH=yes
endif
ifneq "$(findstring bt,$(TRANSPORTS))" ""
BLUETOOTH=yes
endif

# Bluetooth
ifeq ($(BLUETOOTH),yes)
CFLAGS+=-DBLUETOOTH
ifeq ($(PI),yes)
LIBS+=./libgattlib.a -lglib-2.0
DEPS=./libgattlib.a
else
LIBS+=-lgattlib -lglib-2.0
endif
endif

OBJS=$(SRCS:.c=.o)

.PHONY: _all
ifeq ($(LIB),yes)
LIB=lib$(NAME).a
_all: $(LIB)
$(LIB): $(OBJS) $(DEPS)
	ar cr $(LIB) $(OBJS)
else
PROG=$(NAME)
_all: $(PROG)
$(PROG): $(OBJS) $(DEPS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $(PROG) $(OBJS) $(LIBS)

debug: $(PROG)
	gdb ./$(PROG)

install: $(PROG)
	install -m 755 -o bin -g bin $(PROG) /usr/bin/$(PROG)
endif

clean:
	rm -rf $(LIB) $(PROG) $(OBJS) $(CLEANFILES)
