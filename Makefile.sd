
#TARGET=pi3

DEBUG?=yes
#DEBUG_MEM?=yes
PTHREADS?=yes
SHARED?=no
STATIC?=no
PAHO?=yes
JS?=yes
ID:=$(shell id -u)

ifneq "$(findstring win,$(TARGET))" ""
ISWIN=yes
endif

ifeq ($(ID),0)
INSTALL_USER=-o root -g root
PREFIX?=/opt/newsd
else
PREFIX?=$(shell echo $$HOME)
endif

# Define SRC_ROOT
current_makefile := $(lastword $(MAKEFILE_LIST))
SRC_ROOT=$(shell echo $$(dirname $(current_makefile)))

CFLAGS+=-I.

# Uses libsmanet? must be included before sdcore as it refs
ifeq ($(SMANET),yes)
	CFLAGS+=-I$(SRC_ROOT)/smanet
	LIBS+=-L$(SRC_ROOT)/smanet -lsmanet$(SUFFIX)
	DEPS+=$(SRC_ROOT)/smanet/libsmanet$(SUFFIX)$(LIBEXT)
endif

# Uses libjs? must be included before sdcore as it refs
ifeq ($(JS),yes)
	CFLAGS+=-I$(SRC_ROOT)/js
	ifeq ($(ISWIN),yes)
		CFLAGS+=-DXP_WIN
	else
		CFLAGS+=-DXP_UNIX
	endif
	LIBS+=-L$(SRC_ROOT)/js -ljs$(SUFFIX) -lm
	DEPS+=$(SRC_ROOT)/js/libjs$(SUFFIX)$(LIBEXT)
endif

ifneq ($(LIBNAME),roles)
	CFLAGS+=-I$(SRC_ROOT)/roles
	LIBS+=-L$(SRC_ROOT)/roles -lroles$(SUFFIX)
	DEPS+=$(SRC_ROOT)/roles/libroles$(SUFFIX)$(LIBEXT)
endif

ifneq ($(LIBNAME),core)
	CFLAGS+=-I$(SRC_ROOT)/core
	LIBS+=-L$(SRC_ROOT)/core -lcore$(SUFFIX)
	DEPS+=$(SRC_ROOT)/core/libcore$(SUFFIX)$(LIBEXT)
endif

ifneq ($(LIBNAME),transports)
	CFLAGS+=-I$(SRC_ROOT)/transports
	LIBS+=-L$(SRC_ROOT)/transports -ltransports$(SUFFIX)
	DEPS+=$(SRC_ROOT)/transports/libtransports$(SUFFIX)$(LIBEXT)
endif

# Paho MQTT
ifeq ($(PAHO),yes)
	ifeq ($(STATIC),yes)
		_PAHOLDADD=-lssl -lcrypto -lz -ldl
		ifeq ($(TARGET),win32)
			_PAHOSTATIC=-static
			_PAHOLDADD+=-lgdi32 -lcrypt32 -lrpcrt4 -lkernel32
		else ifeq ($(TARGET),win64)
			_PAHOSTATIC=-static
			_PAHOLDADD+=-lgdi32 -lcrypt32 -lrpcrt4
# -lcrypt32 -lrpcrt4 -lkernel32
		endif
	endif
	LIBS+=-lpaho-mqtt3cs$(_PAHOSTATIC) $(_PAHOLDADD)
endif

#ifneq ($(TRANSPORTS),)
#CFLAGS+=-I$(SRC_ROOT)/transports
#SRCS+=$(TRANSPORTS)
#vpath %.c $(SRC_ROOT)/transports
#endif

# Bluetooth
ifeq ($(BLUETOOTH),yes)
ifneq ($(ISWIN),yes)
CFLAGS+=-DBLUETOOTH
LIBS+=-lgattlib -lglib-2.0 -lgobject-2.0 -lgio-2.0
endif
#else
#ifneq ($(TRANSPORTS),)
#_TMPVAR := $(TRANSPORTS)
#TRANSPORTS = $(filter-out bt.c, $(_TMPVAR))
#endif
endif

include $(SRC_ROOT)/Makefile.inc
